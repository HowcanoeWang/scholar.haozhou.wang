const awardi18n = {
    'wang_3dpotatotwin_2024cigr': "awd.cigr24",
    "wang_easyidp_2021jsai":"awd.jsai21",
    "wang_measuring_2018grc": "awd.unb25"
};

const customLinks = {
    ////////////
    // papers //
    ////////////

    // 2025
    'zhang_grapecpnet_2025':{
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/25_compag3.pdf"
    },
    'liu_improved_2025': {
        "PDF": "https://www.mdpi.com/2072-4292/17/5/906/pdf?version=1741184643"
    },
    "li_pointsupervised_2025": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/25_compag2.pdf"
    },
    'blok_highthroughput_2025': {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/25_compag.pdf"
    },
    'zhou_global_2025': {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/25_pp_riceseg.pdf",
        "東大ニュース": "https://www.a.u-tokyo.ac.jp/topics/topics_20250916-1.html"
    },
    'wang_global_2025': {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/25_pp_gwfss.pdf"
    },
    'wang_3dpotatotwin_2025': {
        "東大ニュース": "https://www.a.u-tokyo.ac.jp/topics/topics_20251028-1.html",
        "日本日経新聞": "https://www.nikkei.com/nkd/company/article/?DisplayType=11&ng=DGXZRSP698560_U5A021C2000000&scode=6326"
    },

    // 2024
    "zhang_uavbased_2024": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/24_rs.pdf"
    },

    // 2023
    "wang_dronebased_2023": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/23_pp.pdf",
        "新京报": "https://www.bjnews.com.cn/detail/1698978347129712.html",
        "EurekAlert!": "https://www.eurekalert.org/news-releases/1003639",
        "日本日経新聞": "https://www.nikkei.com/article/DGXZRSP661800_Y3A900C2000000/"
    },
    "drofova_use_2023": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/23_beei.pdf"
    },
    "zhang_tree_2023": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/23_drones.pdf",
        "News": "https://www.a.u-tokyo.ac.jp/topics/topics_20210601-1.html"
    },

    // 2021
    "zhao_efficient_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_rs.pdf"
    },
    "dai_sector_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_cjfr_dai.pdf"
    },
    "hsu_sampling_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_cjfr_hsu.pdf"
    },
    "wang_easyidp_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_easyidp.pdf"
    },
    "feldman_easydcp_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_easydcp.pdf",
        "News": "https://sj.jst.go.jp/news/202109/n0902-03k.html",
        "東大ニュース": "https://www.a.u-tokyo.ac.jp/topics/topics_20210615-1.html"
    },
    "dai_biomass_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_forestry.pdf",
    },
    "wang_estimating_2021": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/21_mcfns.pdf"
    },
    "wang_integrated_2020": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/20_mcfns.pdf"
    },

    // 2019
    "wang_landscape_2019": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/19_afm.pdf",
        "News": "https://mp.weixin.qq.com/s/7icns8uY78pEonHESMmuTg"
    },
    "han_vegetation_2018": {
        "PDF": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/paper/18_acta.pdf"
    },

    /////////////////
    // conferences //
    /////////////////

    // 2025
    "wang_staggcp_2025jsai": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/25_jsai_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/25_jsai_ppt.pdf"
    },
    "wang_camera_2025mlcas": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/25_mlcas2025_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/25_mlcas2025_ppt.pdf"
    },

    // 2024
    "wang_dronebased_2024apfita": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/24_apfita_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/24_apfita_ppt.pdf"
    },
    'wang_3dpotatotwin_2024cigr': {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/24_cigr_abstract.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/24_cigr_poster.pdf"
    },

    // 2023
    "wang_virtual_2023ihrc": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/23_ihrc_abstract.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/23_ihrc_ppt.pdf"
    },
    "wang_virtual_2023mlcas": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/23_mlcas2023_abstract.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/23_mlcas2023_ppt.pdf"
    },

    // 2022
    "wang_estimate_2022ipps": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/22_IPPS_abstract.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/22_IPPS_poster.pdf"
    },
    "wang_procedural_2022jsai": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/22_jsai_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/22_jsai_ppt.pdf"
    },

    // 2021
    "wang_cost-efficient_2021ihrc": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/21_IHC_abstract.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/21_IHC_poster.pdf",
        "URL": "https://www.confrxiv.com/IHRC2021/poster-detail-personal.php?id=312"
    },
    "wang_easyidp_2021tdps": {
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/21_cfy_poster.pdf",
        "URL": "https://www.tdps.jp/tdps001#h.bqdgffvi239x"
    },
    "wang_easyidp_2021jsai": {
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/21_jsai_poster.pdf"
    },

    // 2020
    "feldman_affordable_2020tcc": {
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/20_phenome_poster.pdf"
    },

    // 2019
    "feldman_affordable_2019ipps": {
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/19_IPPS_poster.pdf"
    },
    "wang_estimating_2019wmam": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/19_WFCA_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/19_WFCA_ppt.pdf",
        "Poster": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/19_WFCA_poster.pdf"
    },

    // 2018
    "wang_measuring_2018grc": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/18_GSA_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/18_GSA_ppt.pdf"
    },

    // 2017
    "wang_extracting_2017nmam": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/17_NEMO_abstact.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/17_NEMO_ppt.pdf"
    },
    "wang_uavhirap_2017intecol": {
        "Abstract": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/17_ICE_abstract.pdf",
        "Oral": "https://cdn.jsdelivr.net/gh/HowcanoeWang/scholar.haozhou.wang/files/conf/17_ICE_ppt.pdf"
    }
};

function normalizeTitle(t) {
    // normalize title to only alphabet and number
    return t.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
}

// 使用 fetch API 加载 JSON 文件
function loadLocalJsonData(json_file) {
    return fetch(json_file)  // 替换为你的 JSON 文件路径
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应不正常');
            }
            return response.json();
        })
        .then(data => {
            return data
        })
        .catch(error => {
            console.error('加载数据时出错:', error);
            document.getElementById('data-container').textContent =
                '加载数据时出错: ' + error.message;
        });
}

///////////////////////
// parse scholar.json
///////////////////////
async function initGoogleScholarGraph() {

    try {
        // 等待数据加载完成
        let scholarData = await loadLocalJsonData('./files/scholar.json');

        // 确保数据存在后再生成HTML
        if ( scholarData ) {
            // 将数据赋值给 window.scholarData
            window.scholarData = scholarData;
            console.log('数据已加载:', window.scholarData);

            // 填充数据到 span 元素
            document.getElementById('scholar-totalcite').textContent = window.scholarData.table[0].citations.all;
            document.getElementById('scholar-hindex').textContent = window.scholarData.table[1].h_index.all;

            // 创建echarts表格
            createEchartScholar();

            // 更新论文引用数量
            updateFeaturedCiteCount();
        }
    } catch (error) {
        console.error('初始化页面时出错:', error);
        document.getElementById('bib-output').textContent =
            '加载数据时出错: ' + error.message;
    }
}

function createEchartScholar() {
    const scholarData = window.scholarData;

    const chart = echarts.init(document.getElementById('citationChart'));
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            top: '3%',
            left: '3%',
            right: '3%',
            bottom: '3%',  // Increased bottom margin for legend
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: scholarData.graph.map(item => item.year),
            axisLabel: {
                fontSize: 10,
                color: '#FFFFFF'
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                fontSize: 10,
                color: '#FFFFFF'
            }
        },
        series: [{
            data: scholarData.graph.map(item => item.citations),
            type: 'bar',
            itemStyle: {
                color: '#FFFFFF'
            },
            label: {
                show: false,
                position: 'top',
                fontSize: 10
            }
        }],
    };
    chart.setOption(option);
}

function updateFeaturedCiteCount() {
    const citeSpans = document.querySelectorAll('span.js-cite-count');
    citeSpans.forEach(span => {
        const titleElement = span.closest('h5'); // 获取最近的父级 h5 元素
        if (titleElement) {
            // 获取 h5 的文本内容作为标题，排除 <span> 标签内的内容
            let publicationTitle = titleElement.cloneNode(true); // 克隆元素以避免修改原始DOM
            publicationTitle.querySelectorAll('span').forEach(s => s.remove()); // 移除所有 span 元素
            publicationTitle = publicationTitle.textContent.trim();
            
            if (window.scholarData && window.scholarData.articles) {
                const article = window.scholarData.articles.find(
                    article => article.title.trim().toLowerCase() === publicationTitle.toLowerCase()
                );
                
                if (article && article.cited_by) {
                    span.textContent = article.cited_by;
                }
            }
        }
    });

}

////////////////////////////
// parse publications.bib
////////////////////////////
function loadBibtexData() {
    return fetch('./files/publications.bib')  // 替换为你的 .bib 文件路径
        .then(response => {
            if (!response.ok) {
                throw new Error('无法加载 publication.bib 文件');
            }
            return response.text();  // 注意：.bib 是文本文件，用 .text() 而不是 .json()
        })
        .then(bibContent => {
            let parser = new window.BibLatexParser(bibContent, { processUnexpected: true, processUnknown: true })
            let bibjson = parser.parse()

            return bibjson;
        })
        .catch(error => {
            console.error('加载 .bib 文件时出错:', error);
            document.getElementById('bib-output').textContent =
                '加载数据时出错: ' + error.message;
        });
}

async function initializePage() {
    try {
        // 等待数据加载完成
        let bibjson = await loadBibtexData();

        // 确保数据存在后再生成HTML
        if (bibjson && bibjson.entries) {
            window.bibjson = bibjson;

            const { papersHTML, conferencesHTML } = generatePublicationsHTML(
                window.bibjson.entries,
                customLinks
            );

            // 插入到页面
            document.getElementById('paper').innerHTML = papersHTML;
            document.getElementById('conference').innerHTML = conferencesHTML;
        }
    } catch (error) {
        console.error('初始化页面时出错:', error);
        document.getElementById('bib-output').textContent =
            '加载数据时出错: ' + error.message;
    }
}

// render publications
function generatePublicationsHTML(entries, links) {
    // 确保 entries 是一个数组
    const entriesArray = Array.isArray(entries) ? entries : Object.values(entries);

    // 分类文章
    const papers = entriesArray.filter(entry => entry.bib_type === 'article');
    const conferences = entriesArray.filter(entry => entry.bib_type === 'report');

    document.getElementById("paper-count").innerHTML = papers.length;
    document.getElementById("conf-count").innerHTML = conferences.length;

    // 按年份分组
    const papersByYear = groupByYear(papers);
    const conferencesByYear = groupByYear(conferences);

    // 生成HTML
    const papersHTML = generateYearSections(papersByYear, 'paper', links);
    const conferencesHTML = generateYearSections(conferencesByYear, 'conference', links);

    return {
        papersHTML: papersHTML,
        conferencesHTML: conferencesHTML
    };
}

function groupByYear(entries) {
    const grouped = {};

    entries.forEach(entry => {
        // 从日期中提取年份
        let year = '';
        if (entry.fields.date) {
            const dateMatch = entry.fields.date.match(/\d{4}/);
            year = dateMatch ? dateMatch[0] : '';
        }

        if (!grouped[year]) {
            grouped[year] = [];
        }
        grouped[year].push(entry);
    });

    return grouped;
}

function generateYearSections(entriesByYear, type, links) {
    let html = '';
    const years = Object.keys(entriesByYear).sort((a, b) => b - a); // 降序排列

    years.forEach(year => {
        html += `<h3 class="pt-4">${year}</h3>`;

        entriesByYear[year].forEach(entry => {
            // 生成条目内容
            html += '<hr />';
            html += `
                <div class="csl-bib-body">
                    <div class="csl-entry">
                        ${generateAuthorsHTML(entry.fields.author)}
                        <b><span class="text-muted">${generateDateHTML(entry.fields.date, type)}</span></b>.
                        ${generateTitleHTML(entry.fields.title)}.
                        ${generateJournalOrConferenceHTML(entry, type)}${generatePagesOrLocationHTML(entry, type)}${generateCiteCountHTML(entry, type)}
                        <br/>${generateAwardHTML(entry, awardi18n)}
                    </div>
                </div>
            `;

            // 生成按钮链接
            html += generateButtonsHTML(entry, links);
        });
    });

    return html;
}

function generateAuthorsHTML(authors) {
    if (!authors) return '';

    return authors.map((author, index) => {
        const family = author.family?.[0]?.text || '';
        const given = author.given?.[0]?.text || '';
        const name = `${family}, ${given.split(' ').map(n => n[0]).join('.')}.`;

        // 加粗当前作者（假设名字包含"Wang, H."）
        const isCurrentAuthor = name.includes('Wang, H.');
        return isCurrentAuthor ? `<b>${name}</b>` : name;
    }).join(', ');
}

function generateTitleHTML(titleParts) {
    if (!titleParts) return '';

    return titleParts.map(part => {
        if (part.type === 'text') {
            return part.text;
        }
        return '';
    }).join('');
}

function generateJournalOrConferenceHTML(entry, type) {
    if (type === 'paper') {
        const journal = entry.fields.journaltitle?.[0]?.text || '';
        const volume = entry.fields.volume?.[0]?.text || '';
        return journal ? `<b>${journal}</b> ${volume}` : '';
    } else {
        const institution = entry.fields.institution?.[0]?.[0]?.text || '';
        return institution ? `<b>${institution}</b>` : '';
    }
}

function generatePagesOrLocationHTML(entry, type) {
    if (type === 'paper') {
        const pages = entry.fields.pages?.[0]?.[0]?.[0]?.text || '';
        return pages ? `, ${pages}` : '';
    } else {
        const location = entry.fields.location?.[0]?.[0]?.text || '';
        return location ? `, ${location}` : '';
    }
}

function generateDateHTML(date, type) {
    if (!date) return '';

    if (type === 'paper') {
        const yearMatch = date.match(/\d{4}/);
        return yearMatch ? yearMatch[0] : '';
    } else {
        // 会议日期格式处理
        if (date.includes('/')) {
            const [start, end] = date.split('/');
            const startDate = new Date(start);
            const endDate = new Date(end);

            const startStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            return `${startStr}-${endStr}, ${startDate.getFullYear()}`;
        } else {
            const dateObj = new Date(date);
            return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
    }
}

function generateCiteCountHTML(entry, type) {
    let citeHtml = '';

    if (type === 'paper') {

        let bibtitle = generateTitleHTML(entry.fields.title);

        if (window.scholarData && window.scholarData.articles) {

            // 尝试精确匹配，如果失败则尝试模糊匹配
            let article = window.scholarData.articles.find(
                article => normalizeTitle(article.title) === normalizeTitle(bibtitle)
            );
            
            if (article && article.cited_by) {
                citeHtml = `<span type="button" class="badge badge-secondary badge-cite d-inline ml-2" title="被引数">${article.cited_by}</span>`
            } else {
                console.log(`bib title: [${bibtitle}] or citation count not found in google json`)
            }
        }

    };

    return citeHtml
}

function generateAwardHTML(entry, award) {
    const awardDatai18n = award[entry.entry_key] || '';

    if (awardDatai18n) {
        let awardhtml = `<span class="common-text mb-2 text-muted"><b data-i18n="${awardDatai18n}">award</b></span>`
        return awardhtml;
    } else {
        return ''
    }

}

function generateButtonsHTML(entry, links) {
    const entryLinks = links[entry.entry_key] || {};
    let buttons = '';

    // DOI按钮
    if (entry.fields.doi) {
        buttons += `
      <a class="btn btn-sm btn-outline-dark" href="https://doi.org/${entry.fields.doi}" target="_blank">DOI</a>
    `;
    }

    // 其他自定义按钮
    Object.entries(entryLinks).forEach(([label, url]) => {
        buttons += `
      <a class="btn btn-sm btn-outline-dark" href="${url}" target="_blank">${label}</a>
    `;
    });

    return buttons ? `
    <div class="my-link-btn csl-bib-btn pt-1">
      ${buttons}
    </div>
  ` : '';
}

//'./files/scholar.json'
document.addEventListener('DOMContentLoaded', initGoogleScholarGraph);
document.addEventListener('DOMContentLoaded', initializePage);